<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Query</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f9;
        }
        #query-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        input[type="text"] {
            width: 98%;
            padding: 12px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
        }
        button {
            padding: 12px 18px;
            font-size: 18px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        button:hover {
            background-color: #218838;
        }
        #output {
            margin-top: 20px;
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            max-width: 100%;
            word-wrap: break-word;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            box-sizing: border-box;
            height: 470px;
            overflow-y: auto;
        }

        /* Loading animation */
        .loading {
            font-size: 18px;
            color: #007bff;
            font-weight: bold;
        }

        .dots {
            display: inline;
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>

    <div id="query-container">
        <h2>RAN Part 2 - AI Assistant</h2>
        <input type="text" id="user_question" placeholder="Enter your question..." />
        <input type="text" id="thread_id" placeholder="Enter thread ID..." />
        <button onclick="submitQuestion()" id="submit-btn">Submit</button>
        <div id="output"></div>
    </div>

    <script>
        let dotInterval;
        let dotCount = 0;
        let isStreaming = false; // Flag to track if we are streaming

        // Handle the 'Enter' key event
        document.getElementById('user_question').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                submitQuestion();
            }
        });

        function submitQuestion() {
            const question = document.getElementById('user_question').value;
            const threadId = document.getElementById('thread_id').value;

            if (!question || !threadId) {
                alert("Please enter both a question and a thread ID.");
                return;
            }

            // const url = 'http://127.0.0.1:8000/ran/watsonx/ran/ran_sql_stream'; // Your API endpoint
            const url = 'http://127.0.0.1:8000/ran/watsonx/ran/ran_sql'; // Your API endpoint√∑
            // const url = 'https://icte-ui-icte.apps.watsonx.cpni-wl-dw-d.aws.dishcloud.io/ran/watsonx/ran/ran_sql'; // Your API endpoint

            // Disable input and button while processing
            document.getElementById('user_question').disabled = true;
            document.getElementById('thread_id').disabled = true;
            const submitButton = document.getElementById('submit-btn');
            submitButton.disabled = true;
            submitButton.style.backgroundColor = '#6c757d'; // Change button color to grey

            // Show the "Analyzing..." message with dots animation
            const outputElement = document.getElementById('output');
            outputElement.innerHTML = "<span class='loading'>Analyzing<span class='dots'></span></span>";

            // Start dot animation
            dotCount = 0;  // Reset the dot count
            dotInterval = setInterval(updateDots, 500);  // Update every 1 second

            // Use fetch to make the POST request
            fetch(url, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({ thread_id: threadId, message: question }) // Include thread_id
})
.then(response => {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let text = '';

    reader.read().then(function processText({ done, value }) {
        if (done) {
            // Stop the dots animation and reset flags
            clearInterval(dotInterval);
            isStreaming = false;

            // Enable input and button after fetching is complete
            document.getElementById('user_question').disabled = false;
            document.getElementById('thread_id').disabled = false;
            submitButton.disabled = false;
            submitButton.style.backgroundColor = '#28a745'; // Reset button color
            outputElement.innerHTML = text; // Display the final result
            return;
        }

        // Append and display the chunk of data
        text += decoder.decode(value, { stream: true });
        outputElement.innerHTML = text;

        // Stop the "Analyzing..." animation on first data chunk
        if (!isStreaming) {
            clearInterval(dotInterval); // Stop the dots animation
            isStreaming = true; // Set the streaming flag
        }

        // Continue reading the next chunk
        reader.read().then(processText);
    });
})
.catch(error => {
    console.error("Error during fetch:", error);

    // Enable input and button in case of error
    document.getElementById('user_question').disabled = false;
    document.getElementById('thread_id').disabled = false;
    submitButton.disabled = false;
    submitButton.style.backgroundColor = '#28a745'; // Reset button color

    // Display the error message
    outputElement.innerHTML = "An error occurred while processing your request.";
});
        }

        function updateDots() {
            dotCount++;
            let dots = '.'.repeat(dotCount);  // Add one more dot for each update

            if (dotCount > 3) {
                dotCount = 1;  // Reset after 3 dots
                dots = '.';  // Start again with one dot
            }

            const outputElement = document.getElementById('output');
            outputElement.innerHTML = "<span class='loading'>Analyzing<span class='dots'>" + dots + "</span></span>";
        }
    </script>

</body>
</html>